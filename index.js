!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";function t(t,e){for(var n=0,i=document.getElementsByClassName(t);n<i.length;n++)e(i[n])}function e(t){for(var e;e=t.lastChild;)t.removeChild(e)}function n(t){for(var e=document.createElement(t),n=1,i=arguments;n<i.length;n++){var o=i[n];"string"!=typeof o&&"number"!=typeof o||(o=document.createTextNode(o)),e.appendChild(o)}return e}function i(t,e){t.classList.contains(e)?t.classList.remove(e):t.classList.add(e)}var o=document.getElementById("modal-overlay"),r={},s=document.getElementById("dialog-alert"),a=s.getElementsByClassName("alert-msg")[0],l=null;function c(t,e){l=e,a.innerText=t,u(s)}function d(){o.classList.remove("show"),t("dialog",(function(t){t.classList.remove("show"),t.classList.remove("edit")}))}function u(t){o.classList.add("show"),t.classList.add("show"),p(t)}function p(t){for(var e=0,n=t.getElementsByClassName("error-msg");e<n.length;e++)n[e].innerText="";for(e=0,n=t.getElementsByTagName("input");e<n.length;e++)n[e].classList.remove("error")}s.getElementsByClassName("btn-dialog-close")[0].addEventListener("click",(function(){d()})),s.getElementsByClassName("btn-dialog-confirm")[0].addEventListener("click",(function(){l&&(l(),l=null,d())})),t("btn-show-dialog",(function(t){t.addEventListener("click",(function(){u(document.getElementById(this.getAttribute("data-target")))}))})),t("dialog-input",(function(t){t.getElementsByClassName("btn-dialog-close")[0].addEventListener("click",d),t.getElementsByClassName("btn-dialog-confirm")[0].addEventListener("click",(function(){var e=t.getAttribute("data-type"),n=r[e],i={type:e};p(t);for(var o=!1,s=t.classList.contains("edit"),a=0,l=t.getElementsByTagName("input");a<l.length;a++){var c=l[a],u=c.getAttribute("data-check"),f=c.value;"number"===u&&Number.isNaN(f=Number.parseFloat(f))?(c.classList.add("error"),c.nextElementSibling.innerText="该项须为数字",o=!0):"name"===u&&(""===f?(c.classList.add("error"),c.nextElementSibling.innerText="名称不能为空",o=!0):!s&&n.checkExists(e,f)&&(c.classList.add("error"),c.nextElementSibling.innerText="该名称已存在",o=!0)),i[c.getAttribute("data-prop-name")]=f}o||(n.run(i),d())}))}));var f=null,h=!1,v=[];if("undefined"!=typeof indexedDB){console.log("indexedDB is supported");var g=indexedDB.open("pearl-calculator",1);g.addEventListener("upgradeneeded",(function(t){(f=t.target.result).objectStoreNames.contains("misc")||f.createObjectStore("misc"),f.objectStoreNames.contains("configs")||f.createObjectStore("configs"),f.objectStoreNames.contains("result")||f.createObjectStore("result",{autoIncrement:!0}),console.log("indexedDB upgraded")})),g.addEventListener("success",(function(t){f=t.target.result,console.log("indexedDB initialized"),function(){for(var t=0,e=v;t<e.length;t++)e[t]()}()})),g.addEventListener("error",(function(t){console.log("Failed to open indexedDB"),h=!0}))}else console.log("indexedDB not supported"),h=!0;function y(t){h||(f?t():v.push(t))}function m(t,e){y((function(){f.transaction([t],"readonly").objectStore(t).openCursor().addEventListener("success",(function(t){var n=t.target.result;n&&(e(n.value,n.key),n.continue())}))}))}var E,w=document.getElementById("config-container"),L={};function x(t,e){return w.querySelector('li[data-type="'+t+'"][data-name="'+e+'"]')}function b(t){var e=w.querySelector('li.selected[data-type="'+t+'"]');return e?L[t][e.getAttribute("data-name")]:null}function T(t,i){i=void 0===i||i;var o=t.type,r=t.name,s=x(o,r);null===s&&(s=n("li"),w.querySelector('li[data-type="'+o+'"]')||s.classList.add("selected"),w.appendChild(s)),e(s),s.setAttribute("data-type",o),s.setAttribute("data-name",r);var a=L[o]=L[o]||{};i&&(a[r]?function(t){y((function(){var e=t.type+"/"+t.name,n=f.transaction(["configs"],"readwrite").objectStore("configs").put(t,e);n.addEventListener("success",(function(){console.log("successfully modified config "+e)})),n.addEventListener("error",(function(){console.log("failed to modify config "+e)}))}))}(t):function(t){y((function(){var e=t.type+"/"+t.name,n=f.transaction(["configs"],"readwrite").objectStore("configs").add(t,e);n.addEventListener("success",(function(){console.log("successfully added config "+e)})),n.addEventListener("error",(function(){console.log("failed to add config "+e)}))}))}(t)),a[r]=t;var l=n("button");l.innerText=r,l.classList.add("select");var d=n("button");d.innerText="编辑";var p=n("button");p.innerText="删除",p.addEventListener("click",(function(){c("确定要删除配置"+r+"?",(function(){w.removeChild(s),function(t){y((function(){var e=t.type+"/"+t.name,n=f.transaction(["configs"],"readwrite").objectStore("configs").delete(e);n.addEventListener("success",(function(){console.log("successfully deleted config "+e)})),n.addEventListener("error",(function(){console.log("failed to deleted config "+e)}))}))}(L[o][r]),delete L[o][r]}))})),l.addEventListener("click",(function(){for(var t=0,e=w.querySelectorAll('[data-type="'+o+'"]');t<e.length;t++)e[t].classList.remove("selected");s.classList.add("selected")})),d.addEventListener("click",(function(){!function(t,e){var n=document.querySelector('.dialog[data-type="'+t+'"]');n.classList.add("edit");for(var i=0,o=n.getElementsByTagName("input");i<o.length;i++){var r=o[i].getAttribute("data-prop-name");o[i].value=e[r]}u(n)}(o,t)})),s.appendChild(l),s.appendChild(d),s.appendChild(p)}function k(t,e){return null!==x(t,e)}for(var N=0,C=["tnt-config","pearl-config"];N<C.length;N++)E={checkExists:k,run:function(t){T(t)}},r[C[N]]=E;function z(t,e,n){this.x=t,this.y=e,this.z=n}function B(){this.k=.99,this.g=new z(0,-.03,0),this.pearlEyesHeight=.2125,this.tntPower=4,this.tntExplosionHeight=.06125}function S(t,e,n){this.world=t,this.r0=e,this.v0=n}function I(t,e,n){this.world=t,this.r0=e,this.v0=n}function j(t,e,n,i){this.world=t,this.pearl=e,this.pos1=n.add(new z(0,t.tntExplosionHeight,0)),this.pos2=i.add(new z(0,t.tntExplosionHeight,0))}function A(t,e){return t.createPearl(new z(e.x,e.y,e.z),new z(e.vx,e.vy,e.vz))}function V(t,e,n){return t.createTntLauncher(e,new z(n.x1,n.y1,n.z1),new z(n.x2,n.y2,n.z2))}!function(t){m("configs",t)}((function(t){T(t,!1)})),z.prototype.add=function(t){return new z(this.x+t.x,this.y+t.y,this.z+t.z)},z.prototype.minus=function(t){return new z(this.x-t.x,this.y-t.y,this.z-t.z)},z.prototype.multiply=function(t){return new z(t*this.x,t*this.y,t*this.z)},z.prototype.distance2=function(t){var e=this.x-t.x,n=this.y-t.y,i=this.z-t.z;return e*e+n*n+i*i},z.prototype.distance=function(t){return Math.sqrt(this.distance2(t))},z.prototype.unitVecTo=function(t){return t.minus(this).multiply(1/this.distance(t))},z.prototype.distance2d2=function(t){var e=this.x-t.x,n=this.z-t.z;return e*e+n*n},B.prototype.createPearlTrajectory=function(t,e){return new I(this,t,e)},B.prototype.createTntLauncher=function(t,e,n){return new j(this,t,e,n)},B.prototype.createPearl=function(t,e){return new S(this,t,e)},S.prototype.step=function(t){var e=this.world.createPearlTrajectory(this.r0,this.v0);return new S(this.world,e.getPosition(t||1),e.getVelocity(t||1))},I.prototype.getVelocity=function(t){var e=this.world.g.multiply(1/(1-this.world.k));return this.v0.minus(e).multiply(Math.pow(this.world.k,t)).add(e)},I.prototype.getPosition=function(t){var e=this.world.k,n=this.world.g;return this.r0.add(this.v0.add(n.multiply(1/(e-1))).multiply((1-Math.pow(e,t))/(1-e))).add(n.multiply(t/(1-e)))},I.prototype.getMaxYTick=function(){var t=this.world.g,e=this.world.k,n=t.multiply(1-e),i=this.v0.minus(n).y,o=n.y;return i>0&&o<0||i<0&&o>0?Math.ceil(Math.log(-o/i)/Math.log(e)):null},j.prototype.getInitialVelocity=function(t,e){var n=2*this.world.tntPower,i=this.pearl.r0,o=i.add(new z(0,this.world.pearlEyesHeight,0)),r=this.pos1.unitVecTo(o).multiply(t*(1-i.distance(this.pos1)/n)),s=this.pos2.unitVecTo(o).multiply(e*(1-i.distance(this.pos2)/n));return r.add(s).add(this.pearl.v0)},j.prototype.solveInitialVelocity=function(t,e){var n=this.world.g,i=this.world.k;return t.minus(this.pearl.r0).minus(n.multiply(e/(1-i))).multiply((1-i)/(1-Math.pow(i,e))).add(n.multiply(1-i))},j.prototype.solveTNTAmount=function(t){var e=t.minus(this.pearl.v0),n=this.pearl.r0,i=2*this.world.tntPower,o=n.add(new z(0,this.world.pearlEyesHeight,0)),r=this.pos1.unitVecTo(o).multiply(1-Math.sqrt(this.pos1.distance2(n))/i),s=this.pos2.unitVecTo(o).multiply(1-Math.sqrt(this.pos2.distance2(n))/i),a=r.x*s.z-r.z*s.x;return[(e.x*s.z-e.z*s.x)/a,(r.x*e.z-r.z*e.x)/a]};var P={type:"tnt-amount",inputs:{px:["目标x坐标","x"],pz:["目标z坐标","z"],ticks:["最大游戏刻数","ticks"]},run:function(t,e){for(var n=b("tnt-config"),i=b("pearl-config"),o=A(t,i).step(),r=new z(e.px,0,e.pz),s=V(t,o,n),a=[["游戏刻","初速度","TNT用量","实际到达坐标","误差距离"]],l=1;l<=e.ticks;l++){var c=s.solveInitialVelocity(r,l),d=s.solveTNTAmount(c),u=d[0],p=d[1];if(u>=0&&p>=0){for(var f,h=[[u|=0,p|=0],[u+1,p],[u,p+1],[u+1,p+1]],v=0,g=0,y=0,m=h;y<m.length;y++){var E=s.getInitialVelocity(m[y][0],m[y][1]),w=t.createPearlTrajectory(o.r0,E).getPosition(l),L=w.distance2d2(r);(0===y||L<g)&&(c=E,v=y,g=L,f=w)}a.push([l,c,h[v],f,Math.sqrt(g)])}else a.push([l,c,d,"(无意义)","(无意义)"])}return{tntConfigName:n.name,pearlConfigName:i.name,resultTable:a}}},M={type:"pearl-trajectory",inputs:{n1:["TNT数量1","TNT 1"],n2:["TNT数量2","TNT 2"],ticks:["游戏刻数","ticks"]},run:function(t,e){for(var n=b("tnt-config"),i=b("pearl-config"),o=A(t,i).step(),r=V(t,o,n).getInitialVelocity(e.n1,e.n2),s=t.createPearlTrajectory(o.r0,r),a=[["游戏刻","速度","位置","区块位置"]],l=0;l<=e.ticks;l++){var c=s.getVelocity(l),d=s.getPosition(l);a.push([l,c,d,[d.x>>4,d.z>>4]])}return{tntConfigName:n.name,pearlConfigName:i.name,resultTable:a}}},q=new B,D=document.getElementById("result-container"),H={};function F(t){if("string"==typeof t||"number"==typeof t)return t;if(Array.isArray(t)){for(var e="[",n=0;n<t.length;n++)n>0&&(e+=", "),e+=t[n].toString();return e+="]"}return void 0!==(i=t).x&&void 0!==i.y&&void 0!==i.z?"("+t.x.toFixed(2)+", "+t.y.toFixed(2)+", "+t.z.toFixed(2)+")":void 0;var i}function O(t,e,i){var o;this.type=t,this.inputs=e,this.run=i,this.data=null,this.dataId=null,this.inputElements={},this.res=n("div",o=n("div","未计算")),this.res.classList.add("result"),o.classList.add("placeholder")}O.prototype.render=function(t){var e,o,r=this.res;t.appendChild(e=n("li",o=n("div"),r)),o.classList.add("header");var s=this.inputElements={};for(var a in this.inputs){var l,d,u=this.inputs[a];o.appendChild(l=n("div",n("span",u[0]),d=n("input"))),d.placeholder=u[1],d.type="text",l.classList.add("input-item"),s[a]=d}var p,h=n("button"),v=n("button"),g=n("button");h.innerText="计算",v.innerText="删除",g.innerText="显示/隐藏",o.appendChild(p=n("div",h,v,g)),p.classList.add("button-container");var m=this;v.addEventListener("click",(function(){c("是否删除？",(function(){D.removeChild(e),null!==m.dataId&&function(t){y((function(){var e=f.transaction(["result"],"readwrite").objectStore("result").delete(t);e.addEventListener("success",(function(e){console.log("successfully delete result with key "+t)})),e.addEventListener("error",(function(){console.log("failed to delete result")}))}))}(m.dataId)}))})),h.addEventListener("click",(function(){var t=m.run,e={};for(var n in s)e[n]=Number(s[n].value);(t=t(q,e)).type=m.type,t.inputValues=e,m.data?function(t,e){y((function(){var n=f.transaction(["result"],"readwrite").objectStore("result").put(e,t);n.addEventListener("success",(function(e){console.log("successfully modified result with key "+t)})),n.addEventListener("error",(function(){console.log("failed to result")}))}))}(m.dataId,t):function(t,e){y((function(){var n=f.transaction(["result"],"readwrite").objectStore("result").add(t);n.addEventListener("success",(function(t){console.log("successfully added result with key"+t.target.result),e(t.target.result)})),n.addEventListener("error",(function(){console.log("failed to result")}))}))}(t,(function(t){m.dataId=t})),m.data=t,m.updateResult(),r.classList.remove("hidden")})),g.addEventListener("click",(function(){i(r,"hidden")}))},O.prototype.updateInput=function(){for(var t in this.inputElements)this.inputElements[t].value=this.data.inputValues[t]},O.prototype.updateResult=function(){var t=this.data,i=n("div","珍珠配置：",n("span",t.pearlConfigName),", TNT配置：",n("span",t.tntConfigName));i.classList.add("info");for(var o=t.resultTable,r=n("table"),s=0;s<o.length;s++){for(var a=n("tr"),l=o[s],c=0;c<l.length;c++)a.appendChild(n(0===s?"th":"td",F(l[c])));r.appendChild(a)}e(this.res),this.res.appendChild(i),this.res.appendChild(r)},O.prototype.fromData=function(t){this.data=t,this.updateInput(),this.updateResult()};H={};function R(t){H[t.type]=t}function Y(t){var e=H[t];if(e){var n=new O(t,e.inputs,e.run);return n.render(D),n}}R(P),R(M),t("btn-compute",(function(t){t.addEventListener("click",(function(){Y(t.getAttribute("data-type"))}))})),function(t){m("result",t)}((function(t,e){var n=Y(t.type);n.dataId=e,n.fromData(t)})),t("popup-container",(function(t){var e=t.getElementsByTagName("ul")[0];function n(){e.classList.remove("show"),window.removeEventListener("click",n)}t.getElementsByTagName("button")[0].addEventListener("click",(function(){return e.classList.add("show"),setTimeout((function(){window.addEventListener("click",n)}),0),!0}))})),t("btn-toggle-collapse",(function(t){t.addEventListener("click",(function(){i(document.getElementById(this.getAttribute("data-target")),"collapsed")}))}))}));
